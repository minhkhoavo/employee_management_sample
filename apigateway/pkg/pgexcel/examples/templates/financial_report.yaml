version: "1.0"
name: "Financial Report"
description: "Monthly financial report with budget tracking and conditional formatting"

defaults:
  header_style:
    font:
      name: "Calibri"
      size: 11
      bold: true
      color: "#FFFFFF"
    fill:
      color: "#44546A"
    alignment: "center"
  data_style:
    font:
      name: "Calibri"
      size: 10
    alignment: "left"
  number_format: "#,##0.00"

variables:
  FISCAL_YEAR: "2024"
  QUARTER: "Q4"

sheets:
  # Revenue by Department
  - name: "Revenue"
    query: |
      SELECT 
        department,
        month,
        revenue,
        target,
        (revenue - target) as variance,
        ROUND((revenue / target * 100), 1) as achievement_pct
      FROM revenue_data
      WHERE fiscal_year = $1
      ORDER BY department, month
    query_args:
      - "${FISCAL_YEAR}"
    
    columns:
      - name: "department"
        header: "Department"
        width: 20
        style:
          font:
            bold: true
      
      - name: "month"
        header: "Month"
        width: 12
        style:
          alignment: "center"
      
      - name: "revenue"
        header: "Revenue"
        width: 15
        format: "$#,##0"
        style:
          alignment: "right"
      
      - name: "target"
        header: "Target"
        width: 15
        format: "$#,##0"
        style:
          alignment: "right"
      
      - name: "variance"
        header: "Variance"
        width: 15
        format: "$#,##0;[Red]($#,##0)"
        style:
          alignment: "right"
        conditional:
          - condition: "> 0"
            style:
              font:
                color: "#006100"
          - condition: "< 0"
            style:
              font:
                color: "#9C0006"
      
      - name: "achievement_pct"
        header: "Achievement %"
        width: 15
        format: "0.0%"
        style:
          alignment: "center"
        conditional:
          - condition: ">= 100"
            style:
              fill:
                color: "#C6EFCE"
              font:
                color: "#006100"
                bold: true
          - condition: "< 80"
            style:
              fill:
                color: "#FFC7CE"
              font:
                color: "#9C0006"
    
    layout:
      freeze_rows: 1
      freeze_cols: 1
      auto_filter: true
    
    protection:
      lock_sheet: true
      allow_filter: true
      allow_sort: true

  # Expense Tracking (Editable)
  - name: "Expenses"
    query: |
      SELECT 
        category,
        description,
        budgeted,
        actual,
        remaining,
        notes
      FROM expense_tracking
      WHERE fiscal_year = $1 AND quarter = $2
      ORDER BY category
    query_args:
      - "${FISCAL_YEAR}"
      - "${QUARTER}"
    
    columns:
      - name: "category"
        header: "Category"
        width: 15
      
      - name: "description"
        header: "Description"
        width: 30
      
      - name: "budgeted"
        header: "Budgeted"
        width: 12
        format: "$#,##0"
      
      - name: "actual"
        header: "Actual"
        width: 12
        format: "$#,##0"
        conditional:
          - condition: "> 0"
            style:
              font:
                color: "#000000"
      
      - name: "remaining"
        header: "Remaining"
        width: 12
        format: "$#,##0;[Red]($#,##0)"
        conditional:
          - condition: "< 0"
            style:
              fill:
                color: "#FFCCCC"
      
      - name: "notes"
        header: "Notes"
        width: 35
        style:
          wrap_text: true
    
    style:
      header_style:
        font:
          name: "Calibri"
          size: 11
          bold: true
          color: "#FFFFFF"
        fill:
          color: "#70AD47"
    
    layout:
      freeze_rows: 1
      auto_filter: true
    
    protection:
      password: "finance2024"
      lock_sheet: true
      unlocked_columns:
        - "actual"
        - "notes"
      allow_filter: true

  # Summary Dashboard
  - name: "Summary"
    query: |
      SELECT 
        metric_name,
        current_value,
        previous_value,
        change_pct,
        status
      FROM dashboard_metrics
      WHERE report_date = CURRENT_DATE
      ORDER BY display_order
    
    columns:
      - name: "metric_name"
        header: "Metric"
        width: 25
        style:
          font:
            bold: true
      
      - name: "current_value"
        header: "Current"
        width: 15
        format: "$#,##0"
      
      - name: "previous_value"
        header: "Previous"
        width: 15
        format: "$#,##0"
      
      - name: "change_pct"
        header: "Change %"
        width: 12
        format: "+0.0%;-0.0%"
        conditional:
          - condition: "> 0"
            style:
              font:
                color: "#006100"
          - condition: "< 0"
            style:
              font:
                color: "#9C0006"
      
      - name: "status"
        header: "Status"
        width: 12
        conditional:
          - condition: "== 'GOOD'"
            style:
              fill:
                color: "#C6EFCE"
          - condition: "== 'WARNING'"
            style:
              fill:
                color: "#FFEB9C"
          - condition: "== 'CRITICAL'"
            style:
              fill:
                color: "#FFC7CE"
    
    style:
      header_style:
        fill:
          color: "#4472C4"
    
    layout:
      auto_fit_columns: true
    
    protection:
      lock_sheet: true
      allow_filter: true
